<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="statistics">

	<resultMap type="ExerciseContents" id="ExerciseContents">
		<result property="ExerciseContentsCode"
			column="Exercise_contents_code" />
		<result property="ExerciseSet" column="Exercise_set" />
		<result property="ExerciseReps" column="Exercise_reps" />
		<result property="ExerciseLb" column="Exercise_lb" />
	</resultMap>

	<resultMap type="ExerciseJournal" id="EJMap">
		<id property="ExerciseCode" column="exercise_code"></id>
		<result property="ExerciseName" column="Exercise_name" />
		<result property="start" column="Exercise_date" />
		<collection property="details" resultMap="ExerciseContents" />
	</resultMap>


	<select id="todayList" resultMap="EJMap">
		SELECT
		ei.Exercise_date,et.Exercise_name,ec.Exercise_contents_code,
		ec.Exercise_set,ec.Exercise_reps,ec.Exercise_lb
		FROM exercise_title et JOIN exercise_item ei 
		JOIN exercise_contents ec
		ON et.Exercise_title_code =
		ec.Exercise_title_code AND et.Exercise_code = ei.exercise_code
		WHERE ei.id = #{id} AND ei.Exercise_date = curdate()
	</select>
	
	<select id="monthExerList" resultMap="EJMap">
		SELECT
		ei.Exercise_date,et.Exercise_name,ec.Exercise_contents_code,
		ec.Exercise_set,ec.Exercise_reps,ec.Exercise_lb
		FROM exercise_title et JOIN exercise_item ei 
		JOIN exercise_contents ec
		ON et.Exercise_title_code =
		ec.Exercise_title_code AND et.Exercise_code = ei.exercise_code
		WHERE ei.id = #{id} AND ei.Exercise_date between DATE_SUB(curdate(), INTERVAL 30 DAY) AND curdate()
	</select>
	
	<select id="getWeight" resultType="ExerciseJournal">
		SELECT
		ei.Exercise_date start,ei.userWeight
		FROM exercise_item ei,(select max(exercise_item.Exercise_date) as recently from exercise_item group by exercise_item.Exercise_date) as ei2 
		WHERE ei.id = #{id} and ei.Exercise_date = ei2.recently
	</select>
	
	<select id="getAvgLb" resultType="ExerciseJournal">
		SELECT 
		 mytable.Exercise_date start
			,mytable.Exercise_name
			,ROUND(AVG(mytable.Exercise_lb),1) avgLb,SUM(mytable.Exercise_reps) sumReps,count(mytable.Exercise_set) doneSet,
			ROUND((MAX(mytable.Exercise_lb) * (1+MAX(mytable.reps)/30)),1) oneRm
		FROM (SELECT 
				ei.Exercise_date,et.Exercise_name,ec.Exercise_contents_code,
				ec.Exercise_set,ec.Exercise_reps,ec.Exercise_lb,
				(SELECT ab.Exercise_reps FROM exercise_contents ab WHERE ab.exercise_lb = ec.Exercise_lb AND ab.exercise_contents_code = ec.Exercise_contents_code) reps
			FROM exercise_title et JOIN exercise_item ei 
				JOIN exercise_contents ec
					ON et.Exercise_title_code = ec.Exercise_title_code 
					AND et.Exercise_code = ei.exercise_code
			WHERE ei.id = #{id}
<!-- 			GROUP BY ei.Exercise_date,et.Exercise_name  -->
			) mytable
		GROUP BY mytable.Exercise_date,mytable.Exercise_name 
		ORDER BY mytable.Exercise_date DESC

	
	</select>
	
	<select id="getMetabolism" resultType="besave">
		
	SELECT be_id,username,be_date,b_metabolism,e_requirement
	FROM bedata
	WHERE username=#{username}
	ORDER BY be_date desc limit 1
	
	</select>
	
	<select id="getOverallAvg" resultType="ExerciseJournal">

	SELECT 
		 mytable.Exercise_name
			,ROUND(AVG(mytable.Exercise_lb),1) avgLb,
			ROUND((MAX(mytable.Exercise_lb) * (1+MAX(mytable.reps)/30)),1) oneRm
		FROM (SELECT 
				ei.id,ei.Exercise_date,et.Exercise_name,ec.Exercise_contents_code,
				ec.Exercise_set,ec.Exercise_reps,ec.Exercise_lb,
				(SELECT ab.Exercise_reps FROM exercise_contents ab WHERE ab.exercise_lb = ec.Exercise_lb AND ab.exercise_contents_code = ec.Exercise_contents_code) reps
			FROM exercise_title et JOIN exercise_item ei 
				JOIN exercise_contents ec
					ON et.Exercise_title_code = ec.Exercise_title_code 
					AND et.Exercise_code = ei.exercise_code
					WHERE ei.userWeight BETWEEN 
												(SELECT TRUNCATE(ei.userWeight,-1) minEval FROM exercise_item ei,
													(SELECT MAX(Exercise_date) as recentWeight FROM exercise_item  GROUP BY id) recentWeightT 
 												WHERE ei.id=#{id} AND ei.Exercise_date = recentWeightT.recentWeight ORDER BY minEval limit 1) 
													 AND 
 												(SELECT TRUNCATE(ei.userWeight,-1)+9 maxEval FROM exercise_item ei,
														(SELECT MAX(Exercise_date) as recentWeight FROM exercise_item  GROUP BY id) recentWeightT 
 												WHERE ei.id=#{id} AND ei.Exercise_date = recentWeightT.recentWeight ORDER BY maxEval limit 1)
<!-- 					GROUP BY ei.Exercise_date,et.Exercise_name,ei.id -->
		) mytable,(SELECT MAX(Exercise_date) as recently FROM exercise_item GROUP BY exercise_item.id) recentTable
		WHERE mytable.Exercise_date = recentTable.recently
		GROUP BY mytable.Exercise_name
	</select>
	
<select id="mentiInfo" resultType="TrainerProfile">
	SELECT tp.username,tp.name,tp.sex,tp.career,tp.pro_date,tp.up_filename
	FROM trainer_profile tp,user_management um
	WHERE tp.username = um.manager AND um.username = #{id}
</select>
<insert id="doneSubject">
	INSERT INTO (manager,username,done_subject,done_content,kinds)
	VALUES (#{manager},#{
	
</insert>
</mapper>